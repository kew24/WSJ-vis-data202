---
title: "HW06: COVID Vis Reproduction & Predictive Modeling"
author: "Kaitlyn Westra"
date: "14 October 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(utils)
library(magrittr)
```

## Overview

> *Describe the visualization you are creating at a broad overview level. What is the claim
you are trying to make with it? What kind of data are you working with? etc.*

With this visualization, I am attempting to show the number of COVID cases in 17 European countries, broken down by specified age groups. Hopefully, we will be able to show the trends within each age group -- such as that younger individuals are responsible for more of the most recent COVID cases compared to the elderly people.

The claim I'm trying to make with it comes from a [WSJ article](
https://www.wsj.com/articles/europes-covid-fight-has-a-new-target-the-youth-11601553600). Specifically, the claim the article makes is that **"Younger people are driving the current surge in Covid-19 cases across Europe", supposedly due to parties and events with alcohol consumption.**

The data I'll be working with comes from The European Surveilance System (TESSy), which is part of the European Center for Disease Prevention and Control (ECDC). Each data point consists of each country's weekly cases and deaths, for a given age group, gender, hospitalization status, intensive care status, and outcome. 

## Dataset

> *Your more detailed description of the dataset here. Where did it come from? What processing has happened to the data before you got it? etc.*

As stated earlier, the data comes from the ECDC's (COVID-19 Situation Dashboard)[https://qap.ecdc.europa.eu/public/extensions/covid-19/covid-19-mobile.html#enhanced-surveillance-tab]. Each row represents a group of people that all have the same country, age group, gender, hospitalization status, intensive care status, and outcome. This group of people's case number and death number is recorded.

Some information on how they collect and process COVID data can be found on (their website)[https://www.ecdc.europa.eu/en/covid-19/data-collection]. In short, the "a team of epidemiologists screens up to 500 relevant sources to collect the latest figures" from each country, and this data is added to the database. To get the data I'm working with, they have aggregated individuals based on their shared characteristics (age, country, gender, other statuses) and reported the counts.

```{r download-data, include=F, eval=F}
# data_filename <- "data/covid_data.csv"
# url <- "https://opendata.ecdc.europa.eu/covid19/casedistribution/csv"
# 
# if (!dir.exists("data"))
#   dir.create("data")
# if (!file.exists(data_filename)) {
#   download.file(url = url, destfile = data_filename)
# }
```

```{r load-data, include=F, eval=F}
# data_old <- read.csv('./data/covid_data.csv', na.strings = "", fileEncoding = "UTF-8-BOM")
# knitr::kable(head(data_old, 2))
```

```{r download-age-data}
data_filename_age <- "data/enhanced_surveillance_data.CSV"
data <- read.csv(data_filename_age)
```


> *Describe the structure of the data--size, shape, level of granularity, etc.*

In this data, there are `r nrow(data)` rows with `r ncol(data)` columns. Each of these columns is: `r names(data)`. This is a fairly *tidy* dataset, as it is long, not wide, and because each row only contains one observation.


## Wrangling

> *Describe, at a broad level, what you need to do to the data to make it into the form you need for the graph.*

This data is close to the form I'll need it in for my graph. However, some minor changes are outlined below:

- only include the 17 countries of interest  
- change data type of `cases` to "int" (but recode '<=10' values first)  
- change `Onset.week` to only the last two characters: the week number and reformat to number  
- discard data before week 10  
- remove unneeded columns  
- join/bind(?) data based on shared information (e.g., Week 15 cases for 65+ should be summed)  
- group all ages < 15 together  
- group all ages > 65 together  

```{r exclude-countries}
desired_countries <- c("Croatia", "Cyprus", "Czechia", "Denmark", "Estonia", "Finland",
                       "Germany", "Iceland", "Ireland", "Latvia", "Luxembourg", "Malta",
                       "Netherlands", "Norway", "Poland", "Portugal", "Sweden")
data <- data %>%
  filter(Reporting.country %in% desired_countries) %>%
  mutate(Reporting.country = factor(Reporting.country))
```

(? -- is there a better way to drop levels than just mutating with `factor`? I tried using `droplevels` but that wasn't seeming to work for me...)

```{r retype-cases}
data <- data %>%
  mutate(
    Cases = as.character(Cases),
    Cases = if_else(Cases == '<=10', '1', Cases),
    Cases = as.numeric(Cases)
  )
```

```{r reformat-week}
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

data <- data %>%
  mutate(Onset.week = as.character(Onset.week)) %>%
  filter(Onset.week != "-") %>%
  mutate(
    Week2020 = substrRight(Onset.week, 2),
    Week2020 = as.numeric(Week2020)
  )
```

  
```{r exclude-early-data}
too_early <- c("2019-W51", "2020-W01", "2020-W03", "2020-W04", "2020-W05", 
               "2020-W06", "2020-W07", "2020-W08", "2020-W09", "-")
data <- data %>%
  filter(!(Onset.week %in% too_early)) %>%
  mutate(Onset.week = factor(Onset.week))
```


```{r remove-columns}
data <- data %>%
  select(Week2020, Cases, Age.group)
```

```{r join-and-sum-data}
#(join & sum data)
#? Don't really know how to approach this...
```


```{r group-ages}
#? Don't really know how to approach this...
#- group all ages < 15 together  
#- group all ages > 65 together 
```


## Visualization


```{r plotting}
ggplot(data, mapping = aes(x = Week2020, y = Cases, color = Age.group )) +
  geom_line() +
  theme_bw() +
  labs(title = "Confirmed Covid-19 cases in 17 European countries \nby age group",
       y = "", x = "WEEKS INTO 2020", color = "",
       caption = "Note: Countries include Croatia, Cyprus, Czech republic, Denmark, Estonia, Finland, Germany, \nIceland, Ireland, Latvia, Luxembourg, Malta, Netherlands, Norway, Poland, Portugal and Sweden \nSource: European Surveillance System, part of the European Center for Disease Prevention and Control") +
  theme(plot.caption = element_text(hjust = 0),
        plot.title = element_text(face = "bold"))
```

Ok, I'm obviously not finished yet -- but I've got a good start on this, and that's all I can do for now. Next, I'd like to do the things that were unfinished above (join & sum, then group ages). Besides these wrangling tasks, I'm also hoping to figure out how to best show the lines (hopefully `geom_line` would just work once I complete the wrangling tasks), match the colors using custom hex values from the original graph, specify the gridlines to match the original graph

Additionally, it's kind of scaring me that there doesn't seem to be a huge spike around Week 15. The viz I'm copying shows this, so that's a bit concerning that my data doesn't seem to have this. Hopefully fixing those other things mentioned above would magically solve this problem, too? Otherwise, I can look into the potential of missing data... :(

To demonstrate the lack of a spike, here's my plot, but with bars...

```{r plotting-bars}
ggplot(data, mapping = aes(x = Week2020, y = Cases, fill = Age.group )) +
  geom_col(position = "dodge") +
  theme_bw() +
  labs(title = "Confirmed Covid-19 cases in 17 European countries \nby age group",
       y = "", x = "WEEKS INTO 2020", fill = "", 
       caption = "Note: Countries include Croatia, Cyprus, Czech republic, Denmark, Estonia, Finland, Germany, \nIceland, Ireland, Latvia, Luxembourg, Malta, Netherlands, Norway, Poland, Portugal and Sweden \nSource: European Surveillance System, part of the European Center for Disease Prevention and Control") +
  theme(plot.caption = element_text(hjust = 0),
        plot.title = element_text(face = "bold"))
```



## Analysis

*Analysis goes here.*
